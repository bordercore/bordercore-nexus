{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block content %}

    <div id="vue-app" class="align-items-center mb-3">

        <div class="d-flex mb-3">
            <div class="flex-grow-1 me-auto align-self-center">
                <ul class="breadcrumb mb-0 pt-0 pb-0" v-cloak>
                    <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                    <li class="breadcrumb-item active">[[ nodeName ]]</li>
                </ul>
            </div>
            <Transition name="fade" v-cloak>
                <div v-if="editLayout" class="text-primary ms-auto me-5">
                    Edit Layout
                </div>
            </Transition>
            <drop-down-menu
                ref="dropDownMenu"
                class="me-3"
                v-cloak
            >
                <template #dropdown class="mt-0">
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="onEditNode">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                Edit node
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="openCollectionModal">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New collection
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="openAddNoteModal">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New note
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="openSelectImageModal">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New media
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="openAddQuoteModal">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New quote
                            </span>
                        </a>
                    </li>
                    <li v-if="!hasTodoList">
                        <a class="dropdown-item" href="#" @click.prevent="onAddTodoList">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New todo list
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="openAddNodeModal">
                            <span v-cloak>
                                <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                New node
                            </span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" @click.prevent="editLayout = !editLayout">
                            <span v-cloak>
                                <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                                [[ editLayoutDropDownItemValue ]]
                            </span>
                        </a>
                    </li>
                </template>
            </drop-down-menu>

            <div class="modal fade" id="modalEditNode" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">
                                Edit Node
                            </h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <label class="col-lg-3 col-form-label" for="inputTitle">Name</label>
                                <div class="col-lg-9">
                                    <input type="text" autocomplete="off" maxlength="200" id="id_node_name" :value="nodeName" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <input class="btn btn-primary" type="button" value="Save" @click.prevent="onClickEditNode">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <todo-editor
            ref="editTodo"
            :priority-list="JSON.parse('{{ priority_list }}')"
            edit-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
            create-todo-url="{% url 'todo-list' %}"
            tag-search-url="{% url 'tag:search' %}?query="
            @add="addNodeTodo"
            @edit="handleTodoEdit"
        >
        </todo-editor>

        <div class="d-flex g-0 h-100 mx-2">
            <div
                v-for="(column, colIndex) in layout"
                :key="colIndex"
                class="node-column"
            >
                <slick-list
                    v-model:list="layout[colIndex]"
                    :distance="3"
                    @update:list="handleLayoutChange"
                    @sort:start="handleSortStart"
                    axis="xy"
                    group="node_column"
                    helper-class="slicklist-helper-bare"
                >
                    <slick-item
                        v-for="(row, rowIndex) in layout[colIndex]"
                        :key="row.uuid"
                        :index="rowIndex"
                        :disabled="!editLayout"
                    >
                        <div class="slicklist-list-item-inner position-relative" :style="'z-index: ' + (300 - (colIndex*100) - rowIndex)">
                            <div v-if="row.type === 'collection'">
                                <collection-object-list
                                    node-uuid="{{ object.uuid }}"
                                    :uuid="row.uuid"
                                    :collection-object-list-initial="row"
                                    add-new-bookmark-url="{% url "collection:add_new_bookmark" %}"
                                    :collection-detail-url="'{% url "collection:detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.uuid)"
                                    edit-collection-url="{% url "node:update_collection" %}"
                                    edit-object-note-url="{% url "collection:update_object_note" %}"
                                    :get-object-list-url="'{% url "collection:get_object_list" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.uuid)"
                                    remove-object-url="{% url "collection:remove_object" %}"
                                    sort-objects-url="{% url "collection:sort_objects" %}"
                                    delete-collection-url="{% url "node:delete_collection" %}"
                                    @open-note-image-modal="openModalNoteImage"
                                    @open-collection-edit-modal="openModalCollectionEdit"
                                    @open-object-select-modal="openObjectSelectModal"
                                    @edit-layout="onEditLayout"
                                >
                                </collection-object-list>
                            </div>
                            <div v-if="row.type === 'note'">
                                <node-note
                                    node-uuid="{{ object.uuid }}"
                                    :node-note-initial="row"
                                    :note-url="'{% url "blob-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.uuid)"
                                    set-note-color-url="{% url "node:set_note_color" %}"
                                    delete-note-url="{% url 'node:delete_note' %}"
                                    @open-note-metadata-modal="openModalNoteEdit"
                                    @edit-layout="onEditLayout"
                                >
                                </node-note>
                            </div>
                            <div v-else-if="row.type === 'todo'">
                                <node-todo-list
                                    ref="todoList"
                                    node-uuid="{{ object.uuid }}"
                                    get-todo-list-url="{% url "node:get_todo_list" object.uuid %}"
                                    add-node-todo-url="{% url "node:add_todo" %}"
                                    remove-node-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
                                    sort-node-todos-url="{% url 'node:sort_todos' %}"
                                    delete-todo-list-url="{% url "node:delete_todo_list" %}"
                                    @open-todo-editor-modal="openTodoEditorModal"
                                    @edit-layout="onEditLayout"
                                >
                                </node-todo-list>
                            </div>
                            <div v-else-if="row.type === 'image'">
                                <node-image
                                    node-uuid="{{ object.uuid }}"
                                    :uuid="row.uuid"
                                    :image-title="row.image_title"
                                    :image-url="row.image_url"
                                    :image-detail-url="'{% url 'blob:detail' '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.image_uuid)"
                                    remove-component-url="{% url 'node:remove_component' %}"
                                    @open-modal-note-image="openModalNoteImage"
                                    @edit-layout="onEditLayout"
                                >
                                </node-image>
                            </div>
                            <div v-else-if="row.type === 'quote'">
                                <node-quote
                                    :uuid="row.uuid"
                                    node-uuid="{{ object.uuid }}"
                                    :quote-options-initial="row.options"
                                    :get-quote-url="'{% url "quote-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.quote_uuid)"
                                    get-and-set-quote-url="{% url 'node:get_quote' %}"
                                    remove-component-url="{% url 'node:remove_component' %}"
                                    edit-quote-url="{% url 'node:update_quote' %}"
                                    @open-quote-edit-modal="openQuoteEditModal"
                                    @edit-layout="onEditLayout"
                                >
                                </node-quote>
                            </div>
                            <div v-else-if="row.type === 'node'">
                                <node-node
                                    :uuid="row.uuid"
                                    parent-node-uuid="{{ object.uuid }}"
                                    :node-options-initial="row.options"
                                    :get-node-info-url="'{% url 'node:preview' '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.node_uuid)"
                                    :node-detail-url="'{% url 'node:detail' '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', row.node_uuid)"
                                    remove-component-url="{% url 'node:remove_component' %}"
                                    edit-node-url="{% url 'node:update_node' %}"
                                    @open-node-modal="openNodeModal"
                                    @edit-layout="onEditLayout"
                                >
                                </node-node>
                            </div>
                        </div>
                    </slick-item>
                </slick-list>
            </div>

            <collection-object-list-modal
                ref="collectionEdit"
                node-uuid="{{ object.uuid }}"
                add-collection-url="{% url 'node:add_collection' %}"
                search-url="{% url 'collection:search' %}?query="
                @edit-layout="onEditLayout"
            >
            </collection-object-list-modal>

            <node-note-modal
                ref="noteEdit"
                @open-modal-note-edit="openModalNoteEdit"
                @edit-layout="onEditLayout"
            >
            </node-note-modal>

            <node-image-modal
                ref="noteImage"
            >
            </node-image-modal>

            <node-quote-modal
                ref="quoteEdit"
                node-uuid="{{ object.uuid }}"
                add-node-url="{% url 'node:add_quote' %}"
                @edit-layout="onEditLayout"
            >
            </node-quote-modal>

            <object-select
                :has-filter="false"
                :initial-doctypes="['media']"
                label="_objectSelectImage"
                ref="objectSelectImage"
                search-object-url="{% url 'search:search_names' %}"
                title="New Media"
                @select-object="selectObjectImage"
            >
            </object-select>
            <object-select
                label="_objectSelectCollection"
                ref="objectSelectCollection"
                search-object-url="{% url 'search:search_names' %}"
                @select-object="selectObjectCollection"
            >
            </object-select>

            <node-node-modal
                ref="selectNode"
                parent-node-uuid="{{ object.uuid }}"
                add-node-url="{% url 'node:add_node' %}"
                search-url="{% url 'node:search' %}?query="
                @select-node="handleSelectNode"
                @edit-layout="onEditLayout"
            >
            </node-node-modal>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ object.layout|json_script:"layout" }}

    <script type="text/javascript">

        const app = createApp({
            name: "NodeDetail",
            delimiters: ["[[", "]]"],
            components: {
                CollectionObjectList,
                CollectionObjectListModal,
                TodoEditor,
                FontAwesomeIcon,
                DropDownMenu,
                NodeImage,
                NodeImageModal,
                NodeNode,
                NodeNote,
                NodeNoteModal,
                NodeQuote,
                NodeQuoteModal,
                NodeNodeModal,
                NodeTodoList,
                ObjectSelect,
                SlickItem,
                SlickList,
            },
            setup() {
                const editLayout = ref(false);
                const layout = ref(JSON.parse(document.getElementById("layout").textContent));
                const nodeName = ref("{{ object.name }}");
                const nodeUuid = ref("{{ object.uuid }}");

                const collectionEdit = ref(null);
                const noteImage = ref(null);
                const noteEdit = ref(null);
                const quoteEdit = ref(null);
                const objectSelectCollection = ref(null);
                const objectSelectImage = ref(null);
                const selectNode = ref(null);
                const todoList = ref(null);
                const editTodo = ref(null);

                let layoutCache = cloneDeep(layout.value);

                const editLayoutDropDownItemValue = computed(() => {
                    return editLayout.value ? "Disable Edit Layout" : "Enable Edit Layout";
                });

                const hasTodoList = computed(() => {
                    for (const col of layout.value) {
                        for (const row of col) {
                            if (row.type === "todo") {
                                return true;
                            }
                        }
                    }
                    return false;
                });

                function addNodeTodo(payload) {
                    todoList.value[0].addNodeTodo(payload);
                };

                function addNote(note) {
                    doPost(
                        "{% url "node:add_note" %}",
                        {
                            "node_uuid": nodeUuid.value,
                            "note_name": note.name,
                            "color": note.color,
                        },
                        (response) => {
                            layout.value = JSON.parse(response.data.layout);
                        },
                        "Note created",
                    );
                };

                function handleLayoutChange(evt) {
                    if (isEqual(layoutCache, layout.value)) {
                        return;
                    }
                    doPost(
                        "{% url "node:change_layout" %}",
                        {
                            "node_uuid": nodeUuid.value,
                            "layout": JSON.stringify(layout.value),
                        },
                        (response) => {
                            layoutCache = cloneDeep(layout.value);
                        },
                    );
                };

                function handleSortStart() {
                    layoutCache = layout.value;
                };

                function handleTodoEdit() {
                    todoList.value[0].getTodoList();
                };

                function onAddTodoList() {
                    doPost(
                        "{% url "node:add_todo_list" %}",
                        {
                            "node_uuid": nodeUuid.value,
                        },
                        (response) => {
                            layout.value = JSON.parse(response.data.layout);
                        },
                        "Todo list created",
                    );
                };

                function onClickEditNode() {
                    const name = document.querySelector("#id_node_name").value;
                    doPut(
                        "{% url 'node-detail' object.uuid %}",
                        {
                            "node_uuid": "{{ object.uuid }}",
                            "name": name,
                        },
                        (response) => {
                            nodeName.value = name;
                            document.querySelector(".node-name").innerHTML = name;
                            const modal = Modal.getInstance(document.querySelector("#modalEditNode"));
                            modal.hide();
                        },
                        "Node edited",
                    );
                };

                function onEditLayout(payload) {
                    layout.value = JSON.parse(payload);
                };

                function onEditNode() {
                    const modal = new Modal("#modalEditNode");
                    modal.show();
                    setTimeout(() => {
                        document.querySelector("#id_node_name").focus();
                    }, 500);
                };

                function openCollectionModal() {
                    collectionEdit.value.openModal(
                        "Add",
                        null,
                        {
                            "collection_type": "ad-hoc",
                            "name": "New Collection",
                            "display": "list",
                            "rotate": -1,
                            "limit": 5,
                            "uuid": "",
                        },
                    );
                };

                function openAddNoteModal() {
                    noteEdit.value.openModal("Add", addNote, {"color": 1});
                };

                function openTodoEditorModal(action, data) {
                    editTodo.value.openModal(action, data);
                };

                function openModalCollectionEdit(callback, data) {
                    collectionEdit.value.openModal("Edit", callback, data);
                };

                function openModalNoteImage(data) {
                    noteImage.value.openModal(data);
                };

                function openModalNoteEdit(callback, data) {
                    noteEdit.value.openModal("Edit", callback, data);
                };

                function openAddNodeModal() {
                    selectNode.value.openModal("Add");
                };

                function openAddQuoteModal() {
                    quoteEdit.value.openModal("Add");
                };

                function openNodeModal(callback, options) {
                    selectNode.value.openModal("Edit", callback, options);
                };

                function openQuoteEditModal(callback, data) {
                    quoteEdit.value.openModal("Edit", callback, data);
                };

                function openObjectSelectModal(callback, returnArgs) {
                    objectSelectCollection.value.openModal(callback, returnArgs);
                };

                function openSelectImageModal() {
                    objectSelectImage.value.openModal();
                };

                function handleSelectNode(node_uuid) {
                    doPost(
                        "{% url "node:add_node" %}",
                        {
                            "parent_node_uuid": nodeUuid.value,
                            "node_uuid": node_uuid,
                        },
                        (response) => {
                            layout.value = JSON.parse(response.data.layout);
                        },
                        "Node created",
                    );
                };

                function selectObjectCollection(object, callback, returnArgs) {
                    const args = {
                        "collection_uuid": returnArgs.collectionUuid,
                    };
                    if (object.doctype === "Bookmark") {
                        args.bookmark_uuid = object.uuid;
                    } else {
                        args.blob_uuid = object.uuid;
                    }

                    doPost(
                        "{% url "collection:add_object" %}",
                        args,
                        (response) => {
                            callback();
                        },
                        "Object created",
                    );
                };

                function selectObjectImage(object, callback) {
                    doPost(
                        "{% url "node:add_image" %}",
                        {
                            "node_uuid": nodeUuid.value,
                            "image_uuid": object.uuid,
                        },
                        (response) => {
                            if (callback) {
                                callback();
                            }
                            layout.value = JSON.parse(response.data.layout);
                        },
                        "Image created",
                    );
                };

                return {
                    addNodeTodo,
                    addNote,
                    collectionEdit,
                    editLayout,
                    editLayoutDropDownItemValue,
                    handleLayoutChange,
                    handleSelectNode,
                    handleSortStart,
                    handleTodoEdit,
                    hasTodoList,
                    layout,
                    noteEdit,
                    objectSelectCollection,
                    objectSelectImage,
                    onAddTodoList,
                    onClickEditNode,
                    onEditNode,
                    openAddNoteModal,
                    openAddQuoteModal,
                    openCollectionModal,
                    openTodoEditorModal,
                    openModalCollectionEdit,
                    openModalNoteImage,
                    openModalNoteEdit,
                    openNodeModal,
                    openQuoteEditModal,
                    openObjectSelectModal,
                    openSelectImageModal,
                    openAddNodeModal,
                    onEditLayout,
                    quoteEdit,
                    noteImage,
                    nodeName,
                    nodeUuid,
                    selectNode,
                    selectObjectCollection,
                    selectObjectImage,
                    todoList,
                    editTodo,
                };
            },
        });
        app.use(Oruga, {
            iconComponent: "font-awesome-icon",
            iconPack: "fa",
            table: {
                sortIcon: "caret-up",
            },
        });
        app.use(Slicksort);
        app.mount("#vue-app");

    </script>

{% endblock %}

{% block help %}

    <div class="d-none" id="help-text">
# Quote Keyboard Shortcuts
- **Right-Arrow** *-* Skip
- **U** *-* Update
    </div>

{% endblock %}
