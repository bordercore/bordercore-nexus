{% extends "base_react.html" %}
{% load vite_tags %}

{% block extra_head %}
    <style>
        /* Markdown editor styles - matching Vue v-md-editor */
        .markdown-editor {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--surface1);
            border-radius: 0.25rem;
            background-color: var(--form-bg);
            color: var(--text1);
        }
        .markdown-editor.drag-over {
            border-color: var(--form-border-color-hover);
        }
        .markdown-editor:focus-within {
            border-color: var(--form-border-color-hover);
        }
        .markdown-toolbar {
            flex-shrink: 0;
            background-color: var(--form-bg);
        }
        .markdown-toolbar-item {
            padding: 0.5rem 0.625rem;
            border: none;
            background: transparent;
            color: var(--text1);
            cursor: pointer;
        }
        .markdown-toolbar-item:hover {
            color: var(--form-bg);
            background-color: var(--text1);
        }
        .toolbar-divider {
            width: 1px;
            height: 20px;
            margin: 0 0.25rem;
            background: var(--border-color);
        }
        .markdown-textarea {
            border: none;
            border-radius: 0 0 0.25rem 0.25rem;
            background-color: var(--form-bg);
            color: var(--text1);
            height: 50vh;
            resize: vertical;
        }
        .markdown-textarea:focus {
            background-color: var(--form-bg-focus);
            caret-color: var(--text4);
            color: var(--text4);
            box-shadow: none;
        }
        /* Date input fixed width */
        .date-input {
            width: 6rem;
            flex: none;
            color-scheme: dark;
        }
        /* Icon button styles */
        .icon-button .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .icon-button .icon-circle.active {
            border-color: var(--accent);
            background: var(--surface2);
        }
        .icon-button:hover .icon-circle {
            border-color: var(--accent);
        }
    </style>
{% endblock %}

{% block title %} {{ title }} {% endblock %}

{% block nav %}
    {% if object %}
        <div class="d-flex mb-3">
            <div class="me-auto align-self-center">
                <ul class="breadcrumb mb-0 pt-0 pb-0">
                    <li class="breadcrumb-item"><a href="{% url 'blob:detail' object.uuid %}">Blob Detail</a></li>
                    <li class="breadcrumb-item active">Edit Blob</li>
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    {% include "common/processing.html" %}

    <div
        id="react-root"
        data-blob-uuid="{{ object.uuid|default:'' }}"
        data-blob-sha1sum="{{ object.sha1sum|default:'' }}"
        data-is-pdf="{{ object.is_pdf|yesno:'true,false'|default:'false' }}"
        data-pdf-page-number="{{ object.data.pdf_page_number|default:1 }}"
        data-cover-url="{{ cover_url|default:'' }}"
        data-date-format="{{ date_format|default:'standard' }}"
        data-is-book="{{ is_book|yesno:'true,false'|default:'false' }}"
        data-csrf-token="{{ csrf_token }}"
        data-submit-url="{{ request.path }}"
        data-tag-search-url="{% url 'tag:search' %}?query="
        data-related-tags-url="{% url 'tag:get_related_tags' %}"
        data-metadata-name-search-url="{% url 'blob:metadata_name_search' %}?query="
        data-get-template-url="{% url 'blob:get_template' %}"
        data-update-cover-image-url="{% url 'blob:update_cover_image' %}"
        data-update-page-number-url="{% url 'blob:update_page_number' %}"
        data-parse-date-url="{% url 'blob:parse_date' '666' %}"
        data-blob-detail-url="{% url 'blob:detail' '00000000-0000-0000-0000-000000000000' %}"
    ></div>

    {{ metadata|json_script:"metadata" }}
    {{ tags|json_script:"initial-tags" }}
    {{ template_list|json_script:"templateList" }}
    {% if linked_blob %}
    {{ linked_blob|json_script:"linked-blob" }}
    {% endif %}
    {% if linked_collection %}
    <script type="application/json" id="linked-collection">
    {
        "uuid": "{{ linked_collection.uuid }}",
        "blobs": [
            {% for so in linked_collection.collectionobject_set.all %}
            {"uuid": "{{ so.blob.uuid }}", "name": "{{ so.blob.name|default:'No Name'|escapejs }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
    {% endif %}
    {% if collection_info %}
    <script type="application/json" id="collection-info">
    {"uuid": "{{ collection_info.uuid }}", "name": "{{ collection_info.name|escapejs }}"}
    </script>
    {% endif %}
    <script type="application/json" id="form-data">
    {
        "name": "{{ form.name.value|default:''|escapejs }}",
        "date": "{{ form.date.value|default:''|escapejs }}",
        "content": "{{ form.content.value|default:''|escapejs }}",
        "note": "{{ form.note.value|default:''|escapejs }}",
        "filename": "{{ form.filename.value|default:''|escapejs }}",
        "importance": {% if form.importance.value == 10 %}true{% else %}false{% endif %},
        "is_note": {% if form.is_note.value %}true{% else %}false{% endif %},
        "math_support": {% if form.math_support.value %}true{% else %}false{% endif %}
    }
    </script>
{% endblock %}

{% block javascript_bundles %}
    {{ block.super }}
    {% vite_asset "dist/js/blob-update" %}
{% endblock %}
