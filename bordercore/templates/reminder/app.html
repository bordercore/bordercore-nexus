{% extends "base.html" %}
{% load vite_tags %}

{% block title %}Reminders{% endblock %}

{% block css %}
    {% vite_asset "dist/css/bordercore" %}
{% endblock %}

{% block javascript_bundles %}
    {% vite_asset "dist/js/javascript" %}
{% endblock %}

{% block content %}
  <div class="card-grid ms-2 me-2 mt-2">
    <div class="d-flex justify-content-between mb-3">
      <div class="card-title">
        Reminders
      </div>
      <div>
        <a href="{% url 'reminder:create' %}" class="btn btn-primary btn-sm">
          <i class="fa fa-plus me-2"></i>New Reminder
        </a>
      </div>
    </div>

    <div id="reminders-container">
      <!-- Content loaded via AJAX -->
    </div>
  </div>

  <script>
    const REFRESH_INTERVAL = 10 * 60 * 1000; // 10 minutes in milliseconds
    let refreshTimer;

    function renderReminders(data) {
      const { reminders, pagination } = data;

      if (reminders.length === 0) {
        document.getElementById("reminders-container").innerHTML = `
          <div class="alert alert-info" role="alert">
            <h5>No reminders yet.</h5>
            <p>Create your first reminder to get started.</p>
            <a href="{% url 'reminder:create' %}" class="btn btn-primary btn-sm">
              <i class="fa fa-plus me-2"></i>New Reminder
            </a>
          </div>
        `;
        return;
      }

      let html = '<table class="table table-hover table-sm"><thead><tr><th>Name</th><th>Schedule</th><th>Status</th><th>Next Trigger</th><th class="text-end col-action">Actions</th></tr></thead><tbody>';

      reminders.forEach(reminder => {
        const currentTime = Math.floor(Date.now() / 1000);
        const isReady = reminder.next_trigger_at_unix && reminder.next_trigger_at_unix <= currentTime;
        const statusBadge = reminder.is_active
          ? (isReady ? '<span class="badge bg-danger"><i class="fa fa-check me-1"></i>Ready</span>' : '<span class="badge bg-success">Active</span>')
          : '<span class="badge bg-secondary">Inactive</span>';

        const nextTriggerHtml = reminder.next_trigger_at
          ? `<small>${reminder.next_trigger_at}</small>${isReady ? '<br /><small class="text-danger"><i class="fa fa-exclamation-triangle"></i> Ready to trigger</small>' : ''}`
          : '<small class="text-muted">â€”</small>';

        const pluralUnit = reminder.interval_value !== 1 ? 's' : '';

        html += `
          <tr>
            <td>
              <a href="${reminder.detail_url}">${escapeHtml(reminder.name)}</a>
              ${reminder.note ? `<br /><small class="text-muted">${escapeHtml(reminder.note.split(' ').slice(0, 12).join(' '))}</small>` : ''}
            </td>
            <td>
              <small>Every ${reminder.interval_value} ${reminder.interval_unit_display}${pluralUnit}</small>
            </td>
            <td>${statusBadge}</td>
            <td>${nextTriggerHtml}</td>
            <td class="text-end col-action">
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="fa fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="${reminder.detail_url}">
                      <i class="fa fa-eye text-primary me-3"></i>View
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="${reminder.update_url}">
                      <i class="fa fa-pencil-alt text-primary me-3"></i>Edit
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item text-danger" href="${reminder.delete_url}">
                      <i class="fa fa-trash-alt text-primary me-3"></i>Delete
                    </a>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      // Add pagination
      if (pagination.total_pages > 1) {
        html += '<nav class="mt-3" aria-label="Page navigation"><ul class="pagination justify-content-center">';

        if (pagination.has_previous) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReminders(1); return false;">First</a></li>`;
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReminders(${pagination.previous_page_number}); return false;">Previous</a></li>`;
        }

        html += `<li class="page-item disabled"><span class="page-link">Page ${pagination.current_page} of ${pagination.total_pages}</span></li>`;

        if (pagination.has_next) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReminders(${pagination.next_page_number}); return false;">Next</a></li>`;
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReminders(${pagination.total_pages}); return false;">Last</a></li>`;
        }

        html += '</ul></nav>';
      }

      document.getElementById("reminders-container").innerHTML = html;
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function loadReminders(page = 1) {
      fetch("{% url 'reminder:list-ajax' %}?page=" + page)
        .then(response => response.json())
        .then(data => renderReminders(data))
        .catch(error => console.error("Error loading reminders:", error));
    }

    function startAutoRefresh() {
      // Load immediately on page load
      loadReminders();

      // Then refresh every 10 minutes
      refreshTimer = setInterval(() => loadReminders(), REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
      }
    }

    // Start auto-refresh when page loads
    document.addEventListener("DOMContentLoaded", startAutoRefresh);

    // Stop refresh when page is hidden (optional, saves resources)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
    });
  </script>
{% endblock %}
